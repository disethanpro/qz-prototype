# P7 报表导出弹窗 - 集成说明

## 📦 组件概述

P7 是一个独立的、可复用的报表导出弹窗组件，可以无缝集成到 P4（检测报告页）和 P5（历史记录页）中。

---

## 🎯 核心功能

### 1. **双模式支持**
- **单条导出模式**：用于 P4 页面，导出当前检测报告
- **批量导出模式**：用于 P5 页面，导出多条已勾选记录

### 2. **导出范围选择**
- 单选框：「当前记录」/「已勾选记录」
- P4 自动隐藏范围选择（仅当前记录）
- P5 显示已勾选数量提示

### 3. **目录管理**
- 显示当前导出目录
- 一键更改目录功能
- 目录路径实时更新

### 4. **文件命名预览**
- 规则：`型号_曲轴编号_轮次_日期时间.xlsx`
- 批量导出显示文件数量
- 灰色提示文字说明

### 5. **密码验证**
- 操作员：输入本人密码
- 管理员：输入管理员密码
- 验证失败显示红色错误提示
- 支持重试机制

### 6. **状态反馈**
- 导出过程显示加载动画
- 成功后显示绿色提示条
- 失败保留弹窗并显示错误信息
- 自动更新记录的"已导出"状态

---

## 🔧 集成方法

### 方法一：将弹窗 HTML 复制到目标页面

```html
<!-- 1. 复制 CSS 样式到目标页面的 <style> 标签中 -->
<style>
    /* 从 P7_报表导出弹窗.html 中复制 .modal-overlay 及相关样式 */
</style>

<!-- 2. 在 body 结束前插入弹窗 HTML -->
<div class="modal-overlay" id="exportModal">
    <!-- 复制完整弹窗结构 -->
</div>

<!-- 3. 复制 JavaScript 函数 -->
<script>
    // 复制 openExportModal、closeExportModal、confirmExport 等函数
</script>
```

### 方法二：使用 iframe 嵌入（推荐）

```javascript
// 在 P4 或 P5 页面中调用
function showExportDialog(mode, count, data) {
    // 创建 iframe 弹窗
    const iframe = document.createElement('iframe');
    iframe.src = 'P7_报表导出弹窗.html';
    iframe.style.position = 'fixed';
    iframe.style.top = '0';
    iframe.style.left = '0';
    iframe.style.width = '100%';
    iframe.style.height = '100%';
    iframe.style.border = 'none';
    iframe.style.zIndex = '2000';
    
    // 传递参数
    iframe.onload = function() {
        iframe.contentWindow.openExportModal(mode, count, data);
    };
    
    document.body.appendChild(iframe);
}
```

---

## 📝 API 接口

### `openExportModal(mode, selectedCount, recordData)`

打开导出弹窗并初始化参数。

**参数：**
- `mode` (string): 导出模式
  - `'single'` - 单条导出（P4）
  - `'batch'` - 批量导出（P5）
- `selectedCount` (number): 已选中记录数量（批量模式时必填）
- `recordData` (object): 记录数据（用于生成文件名）
  ```javascript
  {
      model: 'HXN5B',      // 型号
      shaftId: 'QZ0003',   // 曲轴编号
      round: 2,            // 检测轮次
      datetime: '20251112_173045' // 日期时间
  }
  ```

**示例：**

```javascript
// P4 页面：单条导出
openExportModal('single', 1, {
    model: 'DF8B',
    shaftId: 'QZ0012',
    round: 1,
    datetime: getCurrentDateTime()
});

// P5 页面：批量导出 5 条记录
openExportModal('batch', 5);
```

### `closeExportModal()`

关闭导出弹窗。

```javascript
closeExportModal();
```

### `confirmExport()`

执行导出操作（内部调用，由"确认导出"按钮触发）。

---

## 🎨 视觉规范

### 颜色方案
- **主按钮（确认导出）**：`#48BB78` (绿色)
- **次按钮（取消）**：`#E2E8F0` (灰色)
- **成功提示**：`#48BB78` (绿色)
- **错误提示**：`#E53E3E` (红色)
- **遮罩背景**：`rgba(0, 0, 0, 0.6)`

### 尺寸规范
- 弹窗宽度：`500px`
- 按钮高度：`40px`
- 输入框高度：`40px`
- 圆角半径：`4px`

### 字体规范
- 标题：`17px` / 加粗
- 标签：`14px` / 加粗
- 正文：`13-14px` / 常规
- 提示：`12px` / 常规

---

## ⚡ 交互细节

### 键盘快捷键
- `Enter` - 确认导出
- `Esc` - 关闭弹窗

### 动画效果
- 弹窗打开：淡入 + 下滑（0.3s）
- 弹窗关闭：淡出（0.2s）
- 错误提示：抖动动画（0.4s）
- 加载状态：旋转动画（0.6s）

### 用户体验
1. 打开弹窗后自动聚焦密码输入框
2. 点击遮罩可关闭弹窗
3. 密码验证失败自动清空并重新聚焦
4. 导出过程按钮显示加载动画并禁用
5. 成功后提示条 3 秒自动消失

---

## 🔒 安全机制

### 密码验证流程
1. 用户输入密码
2. 前端基本验证（非空、长度）
3. 发送到后端验证（实际项目中）
4. 验证成功执行导出
5. 验证失败显示错误并允许重试

### 权限控制
- 操作员：只能导出本人操作的记录
- 管理员：可以导出所有记录
- 密码验证根据角色匹配对应密码库

---

## 📊 状态更新机制

### 导出成功后的操作
1. 关闭弹窗
2. 显示绿色成功提示
3. 更新记录的"导出状态"为"已导出"
4. 刷新列表显示（P5）或更新当前页状态（P4）

### 实现示例
```javascript
function updateRecordExportStatus(recordIds) {
    // 更新本地状态
    recordIds.forEach(id => {
        const record = getRecordById(id);
        record.exportStatus = '已导出';
        record.exportTime = new Date().toISOString();
    });
    
    // 刷新 UI
    refreshRecordList();
    
    // 同步到后端
    syncToBackend(recordIds);
}
```

---

## 🧪 测试场景

### 单条导出（P4）
1. ✅ 打开弹窗，隐藏"导出范围"
2. ✅ 显示当前记录文件名预览
3. ✅ 密码验证成功后导出
4. ✅ 显示成功提示并标记为已导出

### 批量导出（P5）
1. ✅ 勾选 3 条记录
2. ✅ 打开弹窗，显示"已选中 3 条记录"
3. ✅ 默认选中"已勾选记录"
4. ✅ 文件名预览显示"共 3 个文件"
5. ✅ 密码验证后批量导出
6. ✅ 3 条记录全部标记为已导出

### 错误处理
1. ✅ 密码为空：显示"请输入密码"
2. ✅ 密码错误：显示"密码错误，请重新输入"
3. ✅ 目录不可写：显示警告提示
4. ✅ 网络异常：显示错误提示并保留弹窗

---

## 📁 文件结构

```
QZ 项目/
├── P4_检测报告.html          # 使用单条导出
├── P5_历史记录.html          # 使用批量导出
├── P7_报表导出弹窗.html      # 独立弹窗组件
└── P7_集成说明.md            # 本文档
```

---

## 🚀 快速开始

### 在 P4 中集成（单条导出）

```javascript
// 在 P4 的"导出报表"按钮点击事件中
document.getElementById('exportBtn').addEventListener('click', () => {
    openExportModal('single', 1, {
        model: detectionResult.model,
        shaftId: detectionResult.shaftId,
        round: detectionResult.round,
        datetime: formatDateTime(new Date())
    });
});
```

### 在 P5 中集成（批量导出）

```javascript
// 在 P5 的"批量导出"按钮点击事件中
document.getElementById('batchExportBtn').addEventListener('click', () => {
    const selectedRecords = getSelectedRecords();
    
    if (selectedRecords.length === 0) {
        showToast('请先勾选要导出的记录', 'error');
        return;
    }
    
    openExportModal('batch', selectedRecords.length);
});
```

---

## 💡 最佳实践

1. **统一样式**：确保弹窗样式与 P4、P5 保持一致
2. **错误处理**：所有异常情况都应有明确提示
3. **状态同步**：导出后及时更新记录状态
4. **性能优化**：批量导出时使用队列处理，避免阻塞
5. **用户反馈**：提供清晰的进度提示和结果反馈

---

## 📞 支持

如有问题，请参考以下资源：
- **演示页面**：直接打开 P7_报表导出弹窗.html 查看效果
- **源代码**：所有代码均有详细中文注释
- **集成测试**：在 P4 和 P5 中进行完整测试

---

**版本**：v1.0.0  
**更新日期**：2025-11-12  
**兼容性**：与 P3/P4/P5/P6 样式完全统一





