<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P3 - æ£€æµ‹æ‰§è¡Œç•Œé¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            background-color: #E8EAED;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* ä¸»çª—å£å®¹å™¨ */
        .main-window {
            width: 1920px;
            height: 1080px;
            display: flex;
            flex-direction: column;
            background-color: #E8EAED;
            transform-origin: center center;
        }

        /* è‡ªåŠ¨ç¼©æ”¾ */
        @media screen {
            .main-window {
                transform: scale(var(--scale, 1));
            }
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        .title-bar {
            height: 45px;
            background: linear-gradient(to bottom, #4A5568, #3A4558);
            color: #FFFFFF;
            display: flex;
            align-items: center;
            padding: 0 30px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .title-left {
            display: flex;
            align-items: baseline;
            gap: 8px;
        }

        .system-title {
            font-size: 15px;
            font-weight: normal;
            color: #FFFFFF;
        }

        .version {
            font-size: 10px;
            color: #A0AEC0;
        }

        /* ä¿¡æ¯æ  */
        .info-bar {
            background-color: #F7FAFC;
            padding: 12px 30px;
            border-bottom: 2px solid #E2E8F0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-group {
            display: flex;
            gap: 25px;
            font-size: 13px;
        }

        .info-item {
            display: flex;
            gap: 6px;
        }

        .info-label {
            color: #718096;
        }

        .info-value {
            color: #2D3748;
            font-weight: bold;
        }

        .stage-status {
            font-size: 14px;
            color: #4299E1;
            font-weight: bold;
        }

        /* çŠ¶æ€æç¤ºæ¡ */
        .status-alert {
            background-color: #FED7D7;
            color: #742A2A;
            padding: 10px 30px;
            text-align: center;
            font-size: 14px;
            font-weight: bold;
            display: none;
        }

        .status-alert.show {
            display: block;
        }

        /* ä¸»å†…å®¹åŒº */
        .content-area {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
        }

        /* å·¦ä¾§é˜¶æ®µå¯¼èˆª */
        .left-panel {
            width: 280px;
            background-color: #FFFFFF;
            border-radius: 6px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .panel-title {
            font-size: 15px;
            font-weight: bold;
            color: #2D3748;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #E2E8F0;
        }

        .stage-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .stage-item {
            background-color: #F7FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 6px;
            padding: 12px 15px;
            transition: all 0.3s;
            position: relative;
            cursor: pointer;
        }

        .stage-item.pending {
            background-color: #F7FAFC;
            border-color: #E2E8F0;
        }

        .stage-item.active {
            border-color: #4299E1;
            background-color: #EBF8FF;
        }

        .stage-item.completed {
            border-color: #48BB78;
            background-color: #F0FFF4;
        }

        .stage-item.error {
            border-color: #E53E3E;
            background-color: #FFF5F5;
        }

        .stage-item.skipped {
            border-color: #CBD5E0;
            background-color: #EDF2F7;
        }

        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stage-name {
            font-size: 14px;
            font-weight: 600;
            color: #2D3748;
        }

        .stage-icon {
            font-size: 16px;
        }

        .stage-progress {
            margin-top: 8px;
            font-size: 12px;
            color: #4299E1;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* å¼‚å¸¸è­¦å‘Šæ ‡è¯† */
        .warning-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            background-color: #E53E3E;
            border-radius: 50%;
            color: #FFFFFF;
            font-size: 10px;
            font-weight: bold;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        /* Tooltip */
        .stage-item[data-error]:hover::after {
            content: attr(data-error);
            position: absolute;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            margin-left: 10px;
            padding: 8px 12px;
            background-color: #2D3748;
            color: #FFFFFF;
            font-size: 12px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* å³ä¾§æ£€æµ‹ç»“æœåŒº */
        .right-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #FFFFFF;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .result-header {
            background: linear-gradient(to right, #4299E1, #3182CE);
            color: #FFFFFF;
            padding: 15px 25px;
            font-size: 16px;
            font-weight: bold;
        }

        .result-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* ç­‰å¾…çŠ¶æ€ */
        .waiting-state {
            text-align: center;
            color: #718096;
        }

        .waiting-state .icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .waiting-state .message {
            font-size: 18px;
        }

        /* æµ‹é‡ä¸­çŠ¶æ€ */
        .measuring-state {
            text-align: center;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid #E2E8F0;
            border-top-color: #4299E1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .measuring-message {
            font-size: 18px;
            color: #4299E1;
            font-weight: 600;
        }

        .measuring-hint {
            font-size: 14px;
            color: #718096;
            margin-top: 10px;
        }

        /* å¼‚å¸¸æç¤ºå¡ */
        .error-card {
            width: 100%;
            max-width: 600px;
            background-color: #FFF5F5;
            border: 2px solid #E53E3E;
            border-radius: 8px;
            padding: 30px;
            animation: slideIn 0.5s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .error-title {
            font-size: 20px;
            font-weight: bold;
            color: #742A2A;
            margin-bottom: 15px;
            text-align: center;
        }

        .error-message {
            font-size: 15px;
            color: #742A2A;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .error-suggestion {
            background-color: #FED7D7;
            border-left: 4px solid #E53E3E;
            padding: 12px 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #742A2A;
        }

        .error-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .error-btn {
            padding: 10px 30px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .error-btn-retry {
            background-color: #F6AD55;
            color: #FFFFFF;
        }

        .error-btn-retry:hover {
            background-color: #ED8936;
        }

        .error-btn-contact {
            background-color: #E53E3E;
            color: #FFFFFF;
        }

        .error-btn-contact:hover {
            background-color: #C53030;
        }

        /* ç»“æœå¡ç‰‡ */
        .result-card {
            width: 100%;
            max-width: 600px;
            background-color: #F7FAFC;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            padding: 25px;
            animation: slideIn 0.5s;
        }

        .result-card.fail {
            border-color: #E53E3E;
            background-color: #FFF5F5;
            animation: slideIn 0.5s, borderBreathe 3s ease-in-out 1;
        }

        .result-card.pass {
            border-color: #48BB78;
            background-color: #F0FFF4;
        }

        /* çº¢è‰²è¾¹æ¡†å‘¼å¸æ•ˆæœ */
        @keyframes borderBreathe {
            0%, 100% {
                border-color: #E53E3E;
                box-shadow: 0 0 0 rgba(229, 62, 62, 0);
            }
            50% {
                border-color: #C53030;
                box-shadow: 0 0 20px rgba(229, 62, 62, 0.4);
            }
        }

        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: #2D3748;
            margin-bottom: 20px;
            text-align: center;
        }

        .card-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #E2E8F0;
        }

        .card-row:last-child {
            border-bottom: none;
        }

        .card-label {
            font-size: 15px;
            color: #4A5568;
        }

        .card-value {
            font-size: 16px;
            font-weight: bold;
            color: #2D3748;
        }

        .card-value.pass {
            color: #38A169;
        }

        .card-value.fail {
            color: #E53E3E;
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            background-color: #FFFFFF;
            padding: 15px 30px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .control-btn {
            padding: 10px 35px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
        }

        .control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-start {
            background-color: #48BB78;
            color: #FFFFFF;
        }

        .btn-start:hover:not(:disabled) {
            background-color: #38A169;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .btn-pause {
            background-color: #F6AD55;
            color: #FFFFFF;
        }

        .btn-pause:hover:not(:disabled) {
            background-color: #ED8936;
            box-shadow: 0 4px 12px rgba(246, 173, 85, 0.3);
        }

        .btn-stop {
            background-color: #E53E3E;
            color: #FFFFFF;
        }

        .btn-stop:hover:not(:disabled) {
            background-color: #C53030;
            box-shadow: 0 4px 12px rgba(229, 62, 62, 0.3);
        }

        .btn-back {
            background-color: #A0AEC0;
            color: #FFFFFF;
        }

        .btn-back:hover {
            background-color: #718096;
        }

        .btn-restart {
            background-color: #4299E1;
            color: #FFFFFF;
        }

        .btn-restart:hover {
            background-color: #3182CE;
        }

        /* åº•éƒ¨çŠ¶æ€æ  */
        .statusbar {
            height: 28px;
            background: linear-gradient(to bottom, #4A5568, #3A4558);
            color: #FFFFFF;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 25px;
            font-size: 11px;
        }

        .status-left {
            flex: 1;
        }

        .status-right {
            flex: 1;
            text-align: right;
        }

        .status-normal {
            color: #68D391;
        }

        .status-error {
            color: #FC8181;
        }

        /* æ¨¡æ€å¯¹è¯æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background-color: #FFFFFF;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            min-width: 400px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #2D3748;
            margin-bottom: 15px;
        }

        .modal-message {
            font-size: 15px;
            color: #4A5568;
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 30px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn-primary {
            background-color: #4299E1;
            color: #FFFFFF;
        }

        .modal-btn-primary:hover {
            background-color: #3182CE;
        }

        .modal-btn-secondary {
            background-color: #E2E8F0;
            color: #2D3748;
        }

        .modal-btn-secondary:hover {
            background-color: #CBD5E0;
        }

        /* æ»šåŠ¨æ¡ */
        .result-content::-webkit-scrollbar {
            width: 8px;
        }

        .result-content::-webkit-scrollbar-track {
            background: #F7FAFC;
        }

        .result-content::-webkit-scrollbar-thumb {
            background: #CBD5E0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="main-window">
        <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
        <div class="title-bar">
            <div class="title-left">
                <span class="system-title">æ›²è½´è‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿ</span>
                <span class="version">v1.0.0</span>
            </div>
        </div>

        <!-- çŠ¶æ€æç¤ºæ¡ -->
        <div class="status-alert" id="statusAlert">æ£€æµ‹å·²ç»ˆæ­¢</div>

        <!-- ä¿¡æ¯æ  -->
        <div class="info-bar">
            <div class="info-group">
                <div class="info-item">
                    <span class="info-label">æœºå‹ï¼š</span>
                    <span class="info-value" id="modelInfo">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ›²è½´ç¼–å·ï¼š</span>
                    <span class="info-value" id="shaftInfo">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">å·¥å•å·ï¼š</span>
                    <span class="info-value" id="jobInfo">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">æ£€æµ‹è½®æ¬¡ï¼š</span>
                    <span class="info-value" id="roundInfo">-</span>
                </div>
                <div class="info-item">
                    <span class="info-label">è½´é¢ˆæ•°é‡ï¼š</span>
                    <span class="info-value" id="countInfo">-</span>
                </div>
            </div>
            <div class="stage-status" id="stageStatus">å°±ç»ª</div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="content-area">
            <!-- å·¦ä¾§é˜¶æ®µå¯¼èˆª -->
            <div class="left-panel">
                <div class="panel-title">æ£€æµ‹æµç¨‹</div>
                <div class="stage-list" id="stageList">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- å³ä¾§æ£€æµ‹ç»“æœåŒº -->
            <div class="right-panel">
                <div class="result-header" id="resultHeader">æ£€æµ‹ç»“æœæ˜¾ç¤º</div>
                <div class="result-content" id="resultContent">
                    <div class="waiting-state">
                        <div class="icon">ğŸ“‹</div>
                        <div class="message">ç‚¹å‡»"å¼€å§‹æ£€æµ‹"å¯åŠ¨æ£€æµ‹æµç¨‹</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <button class="control-btn btn-start" id="btnStart" onclick="startDetection()">å¼€å§‹æ£€æµ‹</button>
            <button class="control-btn btn-pause" id="btnPause" onclick="pauseDetection()" disabled>æš‚åœæ£€æµ‹</button>
            <button class="control-btn btn-stop" id="btnStop" onclick="stopDetection()" disabled>ç»ˆæ­¢æ£€æµ‹</button>
            <button class="control-btn btn-restart" id="btnRestart" onclick="restartDetection()" style="display:none;">é‡æ–°å¼€å§‹</button>
            <button class="control-btn btn-back" onclick="goBack()">è¿”å›é¦–é¡µ</button>
        </div>

        <!-- åº•éƒ¨çŠ¶æ€æ  -->
        <div class="statusbar">
            <div class="status-left">è‡ªæ£€çŠ¶æ€ï¼š<span class="status-normal" id="selfCheckStatus">æ­£å¸¸</span></div>
            <div class="status-right" id="currentTime">2025-11-12 17:30:00</div>
        </div>
    </div>

    <!-- æ¨¡æ€å¯¹è¯æ¡† -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">æç¤º</div>
            <div class="modal-message" id="modalMessage">æ¶ˆæ¯å†…å®¹</div>
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-primary" id="modalConfirm">ç¡®å®š</button>
                <button class="modal-btn modal-btn-secondary" id="modalCancel">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== è‡ªåŠ¨ç¼©æ”¾ ====================
        function autoScale() {
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const designWidth = 1920;
            const designHeight = 1080;
            
            const scaleX = windowWidth / designWidth;
            const scaleY = windowHeight / designHeight;
            const scale = Math.min(scaleX, scaleY, 1);
            
            document.documentElement.style.setProperty('--scale', scale);
        }

        window.addEventListener('load', autoScale);
        window.addEventListener('resize', autoScale);

        // ==================== çŠ¶æ€æœºå®šä¹‰ ====================
        const stages = [
            { name: 'å‡†å¤‡å·¥ä½œ', status: 'pending', error: null },
            { name: 'è·³åŠ¨é‡æ£€æµ‹', status: 'pending', error: null },
            { name: 'ç²—ç³™åº¦æ£€æµ‹', status: 'pending', error: null },
            { name: 'æ›´æ¢æ”¯æ’‘æ¿', status: 'pending', error: null },
            { name: 'ç›´å¾„æ£€æµ‹', status: 'pending', error: null },
            { name: 'æ£€æµ‹ç»“æŸ', status: 'pending', error: null }
        ];

        // ==================== å…¨å±€çŠ¶æ€ ====================
        const state = {
            model: '',
            shaftId: '',
            jobNo: '',
            round: 1,
            journalCount: 9,
            
            currentStage: 0,
            currentJournal: 0,
            isRunning: false,
            isPaused: false,
            isTerminated: false,
            
            retryCount: 0,      // å½“å‰æ­¥éª¤é‡è¯•æ¬¡æ•°
            maxRetries: 3,      // æœ€å¤§é‡è¯•æ¬¡æ•°
            
            timer: null,
            
            results: {
                runout: [],
                roughness: [],
                diameter: []
            }
        };

        // ==================== åˆå§‹åŒ– ====================
        function parseUrlParams() {
            const params = new URLSearchParams(window.location.search);
            state.model = params.get('model') || 'HXN5B';
            state.shaftId = params.get('shaft') || 'QZ0003';
            state.jobNo = params.get('job') || '8899';
            state.round = parseInt(params.get('round')) || 2;
            state.journalCount = parseInt(params.get('count')) || 9;

            document.getElementById('modelInfo').textContent = state.model;
            document.getElementById('shaftInfo').textContent = state.shaftId;
            document.getElementById('jobInfo').textContent = state.jobNo;
            document.getElementById('roundInfo').textContent = `ç¬¬ ${state.round} æ¬¡`;
            document.getElementById('countInfo').textContent = state.journalCount;

            // å°è¯•æ¢å¤çŠ¶æ€
            loadStateFromStorage();
            renderStageList();
        }

        // ==================== æ¸²æŸ“é˜¶æ®µåˆ—è¡¨ ====================
        function renderStageList() {
            const container = document.getElementById('stageList');
            container.innerHTML = '';

            stages.forEach((stage, index) => {
                const div = document.createElement('div');
                div.className = `stage-item ${stage.status}`;
                div.id = `stage-${index}`;
                
                if (stage.error) {
                    div.setAttribute('data-error', stage.error);
                }

                let icon = 'â³';
                if (stage.status === 'active') icon = 'â–¶';
                else if (stage.status === 'completed') icon = 'âœ“';
                else if (stage.status === 'error') icon = 'âœ—';
                else if (stage.status === 'skipped') icon = 'âŠ—';

                div.innerHTML = `
                    <div class="stage-header">
                        <span class="stage-name">${index + 1}. ${stage.name}</span>
                        <span class="stage-icon">${icon}</span>
                    </div>
                    <div class="stage-progress" id="progress-${index}" style="display:none;"></div>
                `;

                container.appendChild(div);
            });
        }

        // ==================== æ›´æ–°é˜¶æ®µçŠ¶æ€ ====================
        function updateStageStatus(stageIndex, status, errorMsg = null) {
            stages[stageIndex].status = status;
            stages[stageIndex].error = errorMsg;
            renderStageList();
            saveStateToStorage();

            document.getElementById('stageStatus').textContent = stages[stageIndex].name + (status === 'active' ? 'ä¸­...' : '');
        }

        // ==================== æ›´æ–°è½´é¢ˆè¿›åº¦ ====================
        function updateJournalProgress(stageIndex, current, total, hasWarning = false) {
            const progressDiv = document.getElementById(`progress-${stageIndex}`);
            if (progressDiv) {
                progressDiv.style.display = 'flex';
                
                // æ¸…ç©ºå†…å®¹
                progressDiv.innerHTML = `è½´é¢ˆ ${current} / ${total}`;
                
                // å¦‚æœæœ‰è­¦å‘Šï¼Œæ·»åŠ çº¢è‰²æ ‡è¯†
                if (hasWarning) {
                    const badge = document.createElement('span');
                    badge.className = 'warning-badge';
                    badge.textContent = '!';
                    badge.title = 'è¯¥è½´é¢ˆæ£€æµ‹ç»“æœå¼‚å¸¸';
                    progressDiv.appendChild(badge);
                }
            }
        }

        // ==================== æ ‡è®°å¼‚å¸¸è½´é¢ˆ ====================
        function markJournalWarning(stageIndex, journalNum) {
            // æ ‡è®°è¯¥é˜¶æ®µæœ‰å¼‚å¸¸
            updateJournalProgress(stageIndex, journalNum, state.journalCount, true);
        }

        // ==================== ä¿å­˜çŠ¶æ€åˆ° localStorage ====================
        function saveStateToStorage() {
            const stateData = {
                stages: stages,
                currentStage: state.currentStage,
                currentJournal: state.currentJournal,
                results: state.results,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('detectionState', JSON.stringify(stateData));
        }

        // ==================== ä» localStorage åŠ è½½çŠ¶æ€ ====================
        function loadStateFromStorage() {
            const savedData = localStorage.getItem('detectionState');
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    // æ¢å¤çŠ¶æ€ï¼ˆå¯é€‰ï¼šè¯¢é—®ç”¨æˆ·æ˜¯å¦ç»§ç»­ï¼‰
                    // è¿™é‡Œç®€åŒ–ä¸ºè‡ªåŠ¨åŠ è½½
                    Object.assign(stages, data.stages);
                    state.currentStage = data.currentStage;
                    state.currentJournal = data.currentJournal;
                    state.results = data.results;
                } catch (e) {
                    console.error('çŠ¶æ€æ¢å¤å¤±è´¥', e);
                }
            }
        }

        // ==================== æ¸…é™¤çŠ¶æ€ ====================
        function clearStateFromStorage() {
            localStorage.removeItem('detectionState');
            localStorage.removeItem('detectionResults');
            
            // é‡ç½®æ‰€æœ‰é˜¶æ®µ
            stages.forEach(stage => {
                stage.status = 'pending';
                stage.error = null;
            });
            
            state.currentStage = 0;
            state.currentJournal = 0;
            state.retryCount = 0;
            state.results = { runout: [], roughness: [], diameter: [] };
        }

        // ==================== æ˜¾ç¤ºæµ‹é‡ä¸­ ====================
        function showMeasuring(message, hint = '') {
            const content = `
                <div class="measuring-state">
                    <div class="spinner"></div>
                    <div class="measuring-message">${message}</div>
                    ${hint ? `<div class="measuring-hint">${hint}</div>` : ''}
                </div>
            `;
            document.getElementById('resultContent').innerHTML = content;
        }

        // ==================== æ˜¾ç¤ºå¼‚å¸¸å¡ç‰‡ ====================
        function showError(errorMsg, suggestion, canRetry = true) {
            const retryBtn = canRetry ? `<button class="error-btn error-btn-retry" onclick="retryCurrentStep()">é‡æ–°å°è¯•</button>` : '';
            const contactBtn = state.retryCount >= state.maxRetries ? `<button class="error-btn error-btn-contact" onclick="contactMaintenance()">è”ç³»ç»´æŠ¤äººå‘˜</button>` : '';
            
            const content = `
                <div class="error-card">
                    <div class="error-title">âš ï¸ æ£€æµ‹å¼‚å¸¸</div>
                    <div class="error-message">${errorMsg}</div>
                    <div class="error-suggestion">
                        ğŸ’¡ å¤„ç†å»ºè®®ï¼š${suggestion}
                    </div>
                    <div class="error-actions">
                        ${retryBtn}
                        ${contactBtn}
                    </div>
                </div>
            `;
            document.getElementById('resultContent').innerHTML = content;
            
            // æ›´æ–°å½“å‰é˜¶æ®µä¸ºé”™è¯¯çŠ¶æ€
            updateStageStatus(state.currentStage, 'error', errorMsg);
            
            // æ›´æ–°çŠ¶æ€æ 
            document.getElementById('selfCheckStatus').textContent = 'å¼‚å¸¸';
            document.getElementById('selfCheckStatus').className = 'status-error';
        }

        // ==================== æ¨¡æ‹Ÿéšæœºé”™è¯¯ ====================
        function simulateRandomError() {
            // 10% æ¦‚ç‡è§¦å‘é”™è¯¯ï¼ˆç”¨äºæµ‹è¯•ï¼‰
            return Math.random() < 0.1;
        }

        // ==================== é‡è¯•å½“å‰æ­¥éª¤ ====================
        function retryCurrentStep() {
            state.retryCount++;
            
            if (state.retryCount >= state.maxRetries) {
                showError(
                    'é‡è¯•æ¬¡æ•°å·²è¾¾ä¸Šé™',
                    'è¯·è”ç³»ç»´æŠ¤äººå‘˜æ£€æŸ¥è®¾å¤‡çŠ¶æ€',
                    false
                );
                return;
            }
            
            // æ¢å¤å½“å‰é˜¶æ®µçŠ¶æ€ä¸º active
            updateStageStatus(state.currentStage, 'active');
            
            // æ¢å¤çŠ¶æ€æ 
            document.getElementById('selfCheckStatus').textContent = 'æ­£å¸¸';
            document.getElementById('selfCheckStatus').className = 'status-normal';
            
            // é‡æ–°æ‰§è¡Œå½“å‰é˜¶æ®µ
            executeStage();
        }

        // ==================== è”ç³»ç»´æŠ¤äººå‘˜ ====================
        function contactMaintenance() {
            showModal(
                'è”ç³»ç»´æŠ¤äººå‘˜',
                'æ£€æµ‹è®¾å¤‡å‡ºç°å¼‚å¸¸ï¼Œè¯·è”ç³»ç»´æŠ¤äººå‘˜å¤„ç†ã€‚\n\nè”ç³»ç”µè¯ï¼š400-123-4567',
                () => {
                    // å¯ä»¥è·³è½¬åˆ°æ•…éšœæŠ¥ä¿®é¡µé¢æˆ–è¿”å›é¦–é¡µ
                },
                true
            );
        }

        // ==================== æ˜¾ç¤ºæ£€æµ‹ç»“æœ ====================
        function showResult(stageName, journalNum, value, unit, standard, pass) {
            const cardClass = pass ? 'pass' : 'fail';
            const resultText = pass ? 'âœ“ åˆæ ¼' : 'âœ— ä¸åˆæ ¼';
            const resultClass = pass ? 'pass' : 'fail';
            
            const content = `
                <div class="result-card ${cardClass}">
                    <div class="card-title">è½´é¢ˆ ${journalNum} ${stageName}å®Œæˆ</div>
                    <div class="card-row">
                        <span class="card-label">æµ‹é‡å€¼ï¼š</span>
                        <span class="card-value">${value} ${unit}</span>
                    </div>
                    <div class="card-row">
                        <span class="card-label">æ ‡å‡†è¦æ±‚ï¼š</span>
                        <span class="card-value">${standard}</span>
                    </div>
                    <div class="card-row">
                        <span class="card-label">åˆ¤å®šç»“æœï¼š</span>
                        <span class="card-value ${resultClass}">${resultText}</span>
                    </div>
                </div>
            `;
            document.getElementById('resultContent').innerHTML = content;
        }

        // ==================== å¼€å§‹æ£€æµ‹ ====================
        function startDetection() {
            if (state.isRunning) return;

            state.isRunning = true;
            state.isPaused = false;
            state.isTerminated = false;
            state.retryCount = 0;

            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnPause').disabled = false;
            document.getElementById('btnStop').disabled = false;
            document.getElementById('btnRestart').style.display = 'none';
            document.getElementById('statusAlert').classList.remove('show');

            executeStage();
        }

        // ==================== æ‰§è¡Œé˜¶æ®µ ====================
        function executeStage() {
            if (!state.isRunning || state.isPaused || state.isTerminated) return;

            if (state.currentStage >= 6) {
                completeDetection();
                return;
            }

            updateStageStatus(state.currentStage, 'active');

            // æ¨¡æ‹Ÿéšæœºé”™è¯¯ï¼ˆæµ‹è¯•ç”¨ï¼‰
            if (simulateRandomError()) {
                const errorMessages = [
                    { msg: 'æœºæ¢°æ‰‹æœªå“åº”', suggestion: 'è¯·æ£€æŸ¥æœºæ¢°æ‰‹ç”µæºè¿æ¥' },
                    { msg: 'ä¼ æ„Ÿå™¨é€šè®¯è¶…æ—¶', suggestion: 'è¯·æ£€æŸ¥ä¼ æ„Ÿå™¨è¿æ¥çº¿ç¼†' },
                    { msg: 'æ•°æ®é‡‡é›†å¤±è´¥', suggestion: 'è¯·é‡å¯æ•°æ®é‡‡é›†æ¨¡å—' }
                ];
                const error = errorMessages[Math.floor(Math.random() * errorMessages.length)];
                showError(error.msg, error.suggestion);
                return;
            }

            switch (state.currentStage) {
                case 0: executePrepare(); break;
                case 1: executeRunout(); break;
                case 2: executeRoughness(); break;
                case 3: executeChangeSupport(); break;
                case 4: executeDiameter(); break;
                case 5: executeFinish(); break;
            }
        }

        // ==================== å‡†å¤‡å·¥ä½œ ====================
        function executePrepare() {
            const steps = ['å¼€æœºè‡ªæ£€', 'è®¾å¤‡å¤ä½', 'å…³é—­æœºæ¢°æ‰‹ç”µæº', 'æ›´æ¢æ”¯æ’‘æ¿1', 'å¼€å¯æœºæ¢°æ‰‹ç”µæº'];
            let stepIndex = 0;
            
            function nextStep() {
                if (!state.isRunning || state.isPaused) return;
                
                if (stepIndex >= steps.length) {
                    updateStageStatus(0, 'completed');
                    state.currentStage = 1;
                    state.retryCount = 0;
                    state.timer = setTimeout(executeStage, 1000);
                    return;
                }
                
                showMeasuring(steps[stepIndex] + '...', 'è¯·å‹¿æ“ä½œè®¾å¤‡');
                stepIndex++;
                state.timer = setTimeout(nextStep, 2000);
            }
            
            document.getElementById('resultHeader').textContent = 'å‡†å¤‡å·¥ä½œ';
            nextStep();
        }

        // ==================== è·³åŠ¨é‡æ£€æµ‹ ====================
        function executeRunout() {
            if (state.currentJournal >= state.journalCount) {
                updateStageStatus(1, 'completed');
                state.currentStage = 2;
                state.currentJournal = 0;
                state.retryCount = 0;
                state.timer = setTimeout(executeStage, 1000);
                return;
            }

            const journalNum = state.currentJournal + 1;
            updateJournalProgress(1, journalNum, state.journalCount);
            document.getElementById('resultHeader').textContent = `è½´é¢ˆ ${journalNum} - è·³åŠ¨é‡æ£€æµ‹`;
            
            showMeasuring(`æ­£åœ¨æµ‹é‡è½´é¢ˆ ${journalNum} è·³åŠ¨é‡...`, 'æ›²è½´æ—‹è½¬ä¸­ï¼Œè¯·å‹¿è§¦ç¢°');
            
            state.timer = setTimeout(() => {
                if (!state.isRunning || state.isPaused) return;
                
                const value = (Math.random() * 0.065).toFixed(3);
                const pass = parseFloat(value) <= 0.050;
                
                state.results.runout.push({ journal: journalNum, value: value, pass: pass });
                showResult('è·³åŠ¨é‡æ£€æµ‹', journalNum, value, 'mm', 'â‰¤ 0.050 mm', pass);
                
                // å¦‚æœä¸åˆæ ¼ï¼Œæ ‡è®°å¼‚å¸¸
                if (!pass) {
                    markJournalWarning(1, journalNum);
                }
                
                state.currentJournal++;
                state.timer = setTimeout(executeRunout, 1500);
            }, 2500);
        }

        // ==================== ç²—ç³™åº¦æ£€æµ‹ ====================
        function executeRoughness() {
            if (state.currentJournal >= state.journalCount) {
                updateStageStatus(2, 'completed');
                state.currentStage = 3;
                state.currentJournal = 0;
                state.retryCount = 0;
                state.timer = setTimeout(executeStage, 1000);
                return;
            }

            const journalNum = state.currentJournal + 1;
            updateJournalProgress(2, journalNum, state.journalCount);
            document.getElementById('resultHeader').textContent = `è½´é¢ˆ ${journalNum} - ç²—ç³™åº¦æ£€æµ‹`;
            
            showMeasuring(`æ­£åœ¨æµ‹é‡è½´é¢ˆ ${journalNum} ç²—ç³™åº¦...`, 'ä¼ æ„Ÿå™¨æ¥è§¦æµ‹é‡ä¸­');
            
            state.timer = setTimeout(() => {
                if (!state.isRunning || state.isPaused) return;
                
                const value = (Math.random() * 2.0).toFixed(2);
                const pass = parseFloat(value) <= 1.60;
                
                state.results.roughness.push({ journal: journalNum, value: value, pass: pass });
                showResult('ç²—ç³™åº¦æ£€æµ‹', journalNum, value, 'Î¼m', 'â‰¤ 1.60 Î¼m', pass);
                
                // å¦‚æœä¸åˆæ ¼ï¼Œæ ‡è®°å¼‚å¸¸
                if (!pass) {
                    markJournalWarning(2, journalNum);
                }
                
                state.currentJournal++;
                state.timer = setTimeout(executeRoughness, 1500);
            }, 2500);
        }

        // ==================== æ›´æ¢æ”¯æ’‘æ¿ ====================
        function executeChangeSupport() {
            document.getElementById('resultHeader').textContent = 'æ›´æ¢æ”¯æ’‘æ¿';
            showMeasuring('æ­£åœ¨æ›´æ¢ä¼ æ„Ÿå™¨æ”¯æ’‘æ¿...', 'æœºæ¢°æ‰‹ç”µæºå·²å…³é—­');
            
            state.timer = setTimeout(() => {
                if (!state.isRunning || state.isPaused) return;
                
                updateStageStatus(3, 'completed');
                state.currentStage = 4;
                state.currentJournal = 0;
                state.retryCount = 0;
                state.timer = setTimeout(executeStage, 1000);
            }, 3000);
        }

        // ==================== ç›´å¾„æ£€æµ‹ ====================
        function executeDiameter() {
            if (state.currentJournal >= state.journalCount) {
                updateStageStatus(4, 'completed');
                state.currentStage = 5;
                state.retryCount = 0;
                state.timer = setTimeout(executeStage, 1000);
                return;
            }

            const journalNum = state.currentJournal + 1;
            updateJournalProgress(4, journalNum, state.journalCount);
            document.getElementById('resultHeader').textContent = `è½´é¢ˆ ${journalNum} - ç›´å¾„æ£€æµ‹`;
            
            showMeasuring(`æ­£åœ¨æµ‹é‡è½´é¢ˆ ${journalNum} ç›´å¾„...`, 'å¤šç‚¹æµ‹é‡ä¸­');
            
            state.timer = setTimeout(() => {
                if (!state.isRunning || state.isPaused) return;
                
                const value = (219.95 + Math.random() * 0.10).toFixed(3);
                const pass = Math.abs(parseFloat(value) - 220.00) <= 0.05;
                
                state.results.diameter.push({ journal: journalNum, value: value, pass: pass });
                showResult('ç›´å¾„æ£€æµ‹', journalNum, value, 'mm', '220.00 Â± 0.05 mm', pass);
                
                // å¦‚æœä¸åˆæ ¼ï¼Œæ ‡è®°å¼‚å¸¸
                if (!pass) {
                    markJournalWarning(4, journalNum);
                }
                
                state.currentJournal++;
                state.timer = setTimeout(executeDiameter, 1500);
            }, 2500);
        }

        // ==================== æ£€æµ‹ç»“æŸ ====================
        function executeFinish() {
            document.getElementById('resultHeader').textContent = 'æ£€æµ‹ç»“æŸ';
            showMeasuring('æ­£åœ¨ä¿å­˜æ•°æ®å¹¶å…³é—­ç³»ç»Ÿ...', 'è¯·ç¨å€™');
            
            updateStageStatus(5, 'completed');
            
            state.timer = setTimeout(() => {
                completeDetection();
            }, 2000);
        }

        // ==================== å®Œæˆæ£€æµ‹ ====================
        function completeDetection() {
            state.isRunning = false;
            
            const detectionData = {
                model: state.model,
                shaftId: state.shaftId,
                jobNo: state.jobNo,
                round: state.round,
                journalCount: state.journalCount,
                results: state.results,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('detectionResults', JSON.stringify(detectionData));
            clearStateFromStorage();
            
            setTimeout(() => {
                window.location.href = `P4_æ£€æµ‹æŠ¥å‘Š.html?model=${state.model}&shaft=${state.shaftId}&job=${state.jobNo}&round=${state.round}`;
            }, 1000);
        }

        // ==================== æš‚åœæ£€æµ‹ ====================
        function pauseDetection() {
            if (!state.isRunning || state.isPaused) return;

            state.isPaused = true;
            clearTimeout(state.timer);

            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnStart').textContent = 'ç»§ç»­æ£€æµ‹';
            document.getElementById('btnPause').disabled = true;

            document.getElementById('stageStatus').textContent = 'å·²æš‚åœ';
        }

        // ==================== ç»ˆæ­¢æ£€æµ‹ ====================
        function stopDetection() {
            if (!state.isRunning) return;

            showModal(
                'ç¡®è®¤ç»ˆæ­¢',
                'ç¡®å®šè¦ç»ˆæ­¢å½“å‰æ£€æµ‹å—ï¼Ÿ\nå½“å‰è¿›åº¦å°†ä¿å­˜ï¼Œå¯ä»¥é‡æ–°å¼€å§‹ã€‚',
                () => {
                    state.isRunning = false;
                    state.isPaused = false;
                    state.isTerminated = true;
                    clearTimeout(state.timer);

                    document.getElementById('btnStart').style.display = 'none';
                    document.getElementById('btnPause').disabled = true;
                    document.getElementById('btnStop').disabled = true;
                    document.getElementById('btnRestart').style.display = 'inline-block';
                    document.getElementById('statusAlert').classList.add('show');

                    document.getElementById('stageStatus').textContent = 'å·²ç»ˆæ­¢';
                    
                    const content = `
                        <div class="waiting-state">
                            <div class="icon">âš ï¸</div>
                            <div class="message" style="color: #E53E3E;">æ£€æµ‹å·²ç»ˆæ­¢</div>
                        </div>
                    `;
                    document.getElementById('resultContent').innerHTML = content;
                }
            );
        }

        // ==================== é‡æ–°å¼€å§‹æ£€æµ‹ ====================
        function restartDetection() {
            showModal(
                'ç¡®è®¤é‡æ–°å¼€å§‹',
                'å°†æ¸…ç©ºæ‰€æœ‰æ£€æµ‹çŠ¶æ€å¹¶é‡æ–°å¼€å§‹ï¼Œç¡®å®šå—ï¼Ÿ',
                () => {
                    clearStateFromStorage();
                    renderStageList();
                    
                    state.currentStage = 0;
                    state.currentJournal = 0;
                    state.isTerminated = false;
                    state.retryCount = 0;
                    
                    document.getElementById('btnStart').style.display = 'inline-block';
                    document.getElementById('btnStart').disabled = false;
                    document.getElementById('btnStart').textContent = 'å¼€å§‹æ£€æµ‹';
                    document.getElementById('btnRestart').style.display = 'none';
                    document.getElementById('statusAlert').classList.remove('show');
                    
                    document.getElementById('stageStatus').textContent = 'å°±ç»ª';
                    
                    const content = `
                        <div class="waiting-state">
                            <div class="icon">ğŸ“‹</div>
                            <div class="message">ç‚¹å‡»"å¼€å§‹æ£€æµ‹"å¯åŠ¨æ£€æµ‹æµç¨‹</div>
                        </div>
                    `;
                    document.getElementById('resultContent').innerHTML = content;
                }
            );
        }

        // ==================== è¿”å›é¦–é¡µ ====================
        function goBack() {
            if (state.isRunning) {
                showModal(
                    'ç¡®è®¤è¿”å›',
                    'æ£€æµ‹æ­£åœ¨è¿›è¡Œä¸­ï¼Œç¡®å®šè¿”å›é¦–é¡µå—ï¼Ÿ\nå½“å‰è¿›åº¦å°†ä¿å­˜ã€‚',
                    () => {
                        saveStateToStorage();
                        window.location.href = 'P2_æ“ä½œå‘˜é¦–é¡µ_æ–°å»ºæ£€æµ‹ä»»åŠ¡.html';
                    }
                );
            } else {
                window.location.href = 'P2_æ“ä½œå‘˜é¦–é¡µ_æ–°å»ºæ£€æµ‹ä»»åŠ¡.html';
            }
        }

        // ==================== æ¨¡æ€å¯¹è¯æ¡† ====================
        function showModal(title, message, onConfirm, hideCancel = false) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalOverlay').classList.add('show');

            const confirmBtn = document.getElementById('modalConfirm');
            const cancelBtn = document.getElementById('modalCancel');

            if (hideCancel) {
                cancelBtn.style.display = 'none';
            } else {
                cancelBtn.style.display = 'inline-block';
            }

            confirmBtn.onclick = () => {
                document.getElementById('modalOverlay').classList.remove('show');
                if (onConfirm) onConfirm();
            };

            cancelBtn.onclick = () => {
                document.getElementById('modalOverlay').classList.remove('show');
            };
        }

        // ==================== æ›´æ–°æ—¶é—´ ====================
        function updateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            
            document.getElementById('currentTime').textContent = 
                `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // ==================== é¡µé¢åŠ è½½ ====================
        window.addEventListener('load', () => {
            parseUrlParams();
            updateTime();
            setInterval(updateTime, 1000);
        });
    </script>
</body>
</html>