# 曲轴自动检测系统 - 页面跳转流程说明

## 📊 完整页面导航流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                         P1 - 登录页                              │
│                                                                   │
│  [管理员密码] → 管理员登录                                         │
│  [操作员账号 + 密码] → 操作员登录                                  │
└─────────────────┬───────────────────────┬───────────────────────┘
                  │                       │
                  │ 管理员                │ 操作员
                  ↓                       ↓
    ┌─────────────────────┐   ┌─────────────────────────┐
    │  P6 - 系统配置       │   │  P2 - 检测准备页         │
    │  （管理员专属）       │   │  （操作员首页）          │
    │                      │   │                          │
    │  • 型号配置          │   │  • 新建检测任务          │
    │  • 参数配置          │   │  • 准备条件确认          │
    │  • 通讯配置          │   │  • 近期检测记录          │
    │  • 用户管理          │   │                          │
    │  • 维护标定          │   │  [历史记录] → P5         │
    │  • 操作日志          │   │  [退出] → P1             │
    └─────────────────────┘   └─────┬────────────────────┘
                                    │
                                    │ [开始检测]
                                    ↓
                          ┌─────────────────────┐
                          │  P3 - 检测执行界面   │
                          │                      │
                          │  • 6个检测阶段       │
                          │  • 实时进度显示      │
                          │  • 异常处理          │
                          │  • 状态持久化        │
                          └──────────┬──────────┘
                                     │
                                     │ 检测完成
                                     ↓
                          ┌─────────────────────┐
                          │  P4 - 检测报告       │
                          │                      │
                          │  • 结果展示          │
                          │  • 异常摘要          │
                          │  • 导出报表 → P7     │
                          │  • 复检本曲轴 → P3   │
                          │  • 返回首页 → P2     │
                          └─────────────────────┘


    ┌─────────────────────────────────────────────────────────┐
    │                    P5 - 历史记录                         │
    │                                                           │
    │  • 筛选查询                                               │
    │  • 记录列表                                               │
    │  • 详情抽屉                                               │
    │  • 批量导出 → P7                                          │
    │  • 批量删除（管理员）                                      │
    └─────────────────────────────────────────────────────────┘


    ┌─────────────────────────────────────────────────────────┐
    │                 P7 - 报表导出弹窗                         │
    │                 （被 P4 和 P5 调用）                      │
    │                                                           │
    │  • 导出范围选择                                           │
    │  • 目录选择                                               │
    │  • 文件名预览                                             │
    │  • 密码验证                                               │
    └─────────────────────────────────────────────────────────┘
```

---

## 🔗 各页面跳转详细说明

### P1 - 登录页

**跳转出口：**
- ✅ 管理员登录成功 → `P6_系统配置.html`
- ✅ 操作员登录成功 → `P2_操作员首页_新建检测任务.html?user={账号}&name={姓名}`
- ✅ 首次登录（默认密码）→ 强制修改密码弹窗 → 修改后跳转对应页面

**URL 参数：**
- 无

**实现代码：**
```javascript
// 管理员
window.location.href = 'P6_系统配置.html';

// 操作员
window.location.href = `P2_操作员首页_新建检测任务.html?user=${username}&name=${encodeURIComponent(user.name)}`;
```

---

### P2 - 检测准备页（操作员首页）

**跳转出口：**
- ✅ 点击"开始检测" → `P3_检测执行界面.html?model={型号}&shaft={编号}&job={工单}&round={轮次}&count={轴颈数}`
- ✅ 点击"历史记录" → `P5_历史记录.html`
- ✅ 点击"退出" → `P1_登录页.html`（需确认）
- ✅ 右键菜单"查看详情" → `P4_检测报告.html?model={型号}&shaft={编号}&round={轮次}`
- ✅ 右键菜单"从头重新检测" → 自动填充表单，用户确认后可开始新轮次

**URL 参数接收：**
- `user` - 用户账号（可选）
- `name` - 用户姓名（可选）

**实现代码：**
```javascript
// 开始检测
function startDetection() {
    const model = document.getElementById('crankshaftModel').value;
    const no = document.getElementById('crankshaftNo').value;
    const workOrder = document.getElementById('workOrder').value || '未填写';
    const journalCount = model === 'HXN5B' ? 7 : 9;
    
    const params = new URLSearchParams({
        model: model,
        shaft: no,
        job: workOrder,
        round: 1,
        count: journalCount
    });
    
    window.location.href = `P3_检测执行界面.html?${params.toString()}`;
}

// 查看历史记录
function viewHistory() {
    window.location.href = 'P5_历史记录.html';
}

// 退出登录
function logout() {
    if (confirm('确定要退出登录吗？')) {
        window.location.href = 'P1_登录页.html';
    }
}

// 查看检测详情
function viewDetails() {
    const model = cells[1].textContent;
    const shaftId = cells[2].textContent;
    const round = cells[3].textContent.match(/\d+/)[0];
    
    window.location.href = `P4_检测报告.html?model=${model}&shaft=${shaftId}&round=${round}`;
}
```

---

### P3 - 检测执行界面

**跳转入口：**
- P2 点击"开始检测"
- P4 点击"复检本曲轴"

**跳转出口：**
- ✅ 检测完成自动跳转 → `P4_检测报告.html?model={型号}&shaft={编号}&round={轮次}&result={结果}`
- ✅ 终止检测（可选）→ 返回 `P2_操作员首页_新建检测任务.html`

**URL 参数接收：**
- `model` - 曲轴型号（必填）
- `shaft` - 曲轴编号（必填）
- `job` - 工单号（可选）
- `round` - 检测轮次（必填）
- `count` - 轴颈数量（必填）

**实现代码：**
```javascript
// 页面加载时获取参数
const urlParams = new URLSearchParams(window.location.search);
const model = urlParams.get('model');
const shaftId = urlParams.get('shaft');
const jobNo = urlParams.get('job');
const round = parseInt(urlParams.get('round'));
const journalCount = parseInt(urlParams.get('count'));

// 检测完成后跳转
function onDetectionComplete() {
    const result = state.overallResult; // 'pass' or 'fail'
    const params = new URLSearchParams({
        model: model,
        shaft: shaftId,
        round: round,
        result: result
    });
    
    window.location.href = `P4_检测报告.html?${params.toString()}`;
}
```

---

### P4 - 检测报告

**跳转入口：**
- P3 检测完成自动跳转
- P2 右键菜单"查看详情"
- P5 点击记录查看详情

**跳转出口：**
- ✅ 点击"返回首页" → `P2_操作员首页_新建检测任务.html`
- ✅ 点击"复检本曲轴" → `P3_检测执行界面.html?model={型号}&shaft={编号}&job={工单}&round={轮次+1}&count={轴颈数}`
- ✅ 点击"导出报表" → 调用 `P7_报表导出弹窗.html`（模态弹窗，不跳转）

**URL 参数接收：**
- `model` - 曲轴型号（必填）
- `shaft` - 曲轴编号（必填）
- `round` - 检测轮次（必填）
- `result` - 检测结果（可选）

**实现代码：**
```javascript
// 返回首页
function returnHome() {
    window.location.href = 'P2_操作员首页_新建检测任务.html';
}

// 复检本曲轴
function retestShaft() {
    const params = new URLSearchParams({
        model: currentData.model,
        shaft: currentData.shaftId,
        job: currentData.jobNo,
        round: currentData.round + 1,
        count: currentData.journalCount
    });
    
    window.location.href = `P3_检测执行界面.html?${params.toString()}`;
}

// 导出报表（调用弹窗组件）
function exportReport() {
    openExportModal('single', 1, {
        model: currentData.model,
        shaftId: currentData.shaftId,
        round: currentData.round,
        datetime: currentData.datetime
    });
}
```

---

### P5 - 历史记录

**跳转入口：**
- P2 点击"历史记录"
- P6 管理员菜单（可选）

**跳转出口：**
- ✅ 点击记录 → 打开右侧详情抽屉（不跳转页面）
- ✅ 详情抽屉"查看完整报告" → `P4_检测报告.html?model={型号}&shaft={编号}&round={轮次}`
- ✅ 点击"批量导出" → 调用 `P7_报表导出弹窗.html`（模态弹窗）
- ✅ 点击"返回" → `P2_操作员首页_新建检测任务.html`（或 `P6_系统配置.html` 若是管理员）

**URL 参数接收：**
- 无（筛选条件在页面内部管理）

---

### P6 - 系统配置（管理员专属）

**跳转入口：**
- P1 管理员登录成功

**跳转出口：**
- ✅ 点击菜单切换 → 在当前页面内部切换（不跳转）
- ✅ 点击"退出" → `P1_登录页.html`（需确认）
- ✅ 点击"查看历史记录"（可选）→ `P5_历史记录.html`

**URL 参数接收：**
- 无

---

### P7 - 报表导出弹窗（组件，非独立页面）

**调用方式：**
- P4 和 P5 通过 JavaScript 调用 `openExportModal()` 函数
- 作为模态弹窗显示，不进行页面跳转

**API 调用示例：**
```javascript
// P4 单条导出
openExportModal('single', 1, {
    model: 'HXN5B',
    shaftId: 'QZ0003',
    round: 2,
    datetime: '20251112_173045'
});

// P5 批量导出
openExportModal('batch', selectedRecords.length);
```

---

## 🎯 用户角色流程

### 操作员流程

```
登录 (P1)
    ↓
首页 (P2)
    ├→ 新建检测 → 准备确认 → 开始检测 (P3)
    │                              ↓
    │                          检测完成
    │                              ↓
    │                          查看报告 (P4)
    │                         ↙        ↘
    │                   导出报表 (P7)  复检 → (P3)
    │                         ↓
    ├→ 历史记录 (P5) ← ← ← ← ┘
    │       ↓
    │   查看详情 → (P4)
    │       ↓
    │   批量导出 → (P7)
    │
    └→ 退出 → (P1)
```

### 管理员流程

```
登录 (P1)
    ↓
系统配置 (P6)
    ├→ 型号配置
    ├→ 参数配置
    ├→ 通讯配置
    ├→ 用户管理
    ├→ 维护标定
    ├→ 操作日志
    │
    ├→ 历史记录 (P5)
    │       ↓
    │   查看/删除记录
    │       ↓
    │   批量操作
    │
    └→ 退出 → (P1)
```

---

## 📝 URL 参数汇总表

| 页面 | 参数名 | 类型 | 必填 | 说明 | 示例值 |
|------|--------|------|------|------|--------|
| P1 | - | - | - | 无参数 | - |
| P2 | user | string | ✗ | 用户账号 | op001 |
| P2 | name | string | ✗ | 用户姓名 | 张三 |
| P3 | model | string | ✓ | 曲轴型号 | HXN5B |
| P3 | shaft | string | ✓ | 曲轴编号 | QZ0003 |
| P3 | job | string | ✗ | 工单号 | 8899 |
| P3 | round | number | ✓ | 检测轮次 | 2 |
| P3 | count | number | ✓ | 轴颈数量 | 7 |
| P4 | model | string | ✓ | 曲轴型号 | HXN5B |
| P4 | shaft | string | ✓ | 曲轴编号 | QZ0003 |
| P4 | round | number | ✓ | 检测轮次 | 2 |
| P4 | result | string | ✗ | 检测结果 | pass/fail |
| P5 | - | - | - | 筛选条件在页面内部管理 | - |
| P6 | - | - | - | 无参数 | - |
| P7 | - | - | - | 通过函数调用，非URL参数 | - |

---

## 🔒 权限控制说明

### 操作员权限
- ✅ 访问 P2（首页）
- ✅ 访问 P3（检测执行）
- ✅ 访问 P4（检测报告）
- ✅ 访问 P5（历史记录，仅查看本人）
- ❌ 无法访问 P6（系统配置）

### 管理员权限
- ✅ 访问 P6（系统配置）
- ✅ 访问 P5（历史记录，查看全部）
- ✅ 批量删除记录
- ✅ 查看操作日志
- ✅ 修改系统参数

---

## 💡 最佳实践建议

1. **URL 参数传递**：使用 `URLSearchParams` 构建 URL，确保参数正确编码
2. **状态持久化**：重要数据存储到 `localStorage`，支持断点续传
3. **用户确认**：关键操作（退出、删除）需要二次确认
4. **参数验证**：接收 URL 参数时进行验证，缺失时提供默认值或跳转到首页
5. **错误处理**：跳转失败时提供友好提示，并记录日志

---

**版本**：v1.0.0  
**更新日期**：2025-11-12  
**状态**：✅ 所有页面跳转逻辑已完成





